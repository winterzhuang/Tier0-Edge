
<script type="text/html" data-template-name="supmodel">
    
    <style id="model-selector-style">
        .node-table-models {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        .node-table-models th {
            background: #f5f5f5;
            padding: 8px;
            border-bottom: 2px solid #ddd;
        }
        .node-table-models th,
        .node-table-models td {
            box-sizing: border-box;
        }
        .node-table-models td {
            text-align: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            vertical-align: middle;
        }
        .node-table-models col.col-serial { width: 5%; min-width: 50px; }
        .node-table-models col.col-topic { width: 32%; min-width: 240px; }
        .node-table-models col.col-attr-name { width: 18%; min-width: 150px; }
        .node-table-models col.col-attr-type { width: 12%; min-width: 90px; max-width: 130px; }
        .node-table-models col.col-tag { width: 26%; min-width: 200px; }
        .node-table-models col.col-operation { width: 7%; min-width: 100px; }
        .error_msg {
            color: red;
        }
        /* 强制表格输入撑满单元格，避免聚焦/失焦后宽度收缩 */
        .node-table-models td input[type="text"] {
            width: 100% !important;
            min-width: 0;
            display: block;
        }

        .pagination-control {
            margin: 15px 0;
            text-align: right;
        }

        .pagination-btn {
            padding: 5px 15px;
            margin: 0 5px;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .pagination-btn:hover {
            background-color: #e0e0e0;
        }

        .pagination-info {
            margin: 0 10px;
            color: #666;
        }
        .edit:hover,.remove:hover {
            cursor: pointer; 
        }

        .dropdown-m {
            font-family: Arial, sans-serif;
            /* background-color: #f4f4f4; */
            position: relative;
        }

        .search-input-m {
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .select-dropdown-m {
            width: 70%;
            display: none;
            position: absolute;
            top: 40px;
            left: 104px;
            right: 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: white;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .select-dropdown-m div {
            padding: 10px;
            cursor: pointer;
        }

        .select-dropdown-m div:hover {
            background-color: #f0f0f0;
        }

        .select-dropdown-m div.selected {
            background-color: #007bff;
            color: white;
        }

        .topic-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            z-index: 2000;
        }
        .topic-modal-content {
            width: 600px;
            max-height: 80%;
            overflow-y: auto;
            margin: 50px auto;
            background: #fff;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .topic-modal-header {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .topic-tree {
            border: 1px solid #d9d9d9;
            padding: 10px;
            border-radius: 4px;
            max-height: 420px;
            overflow-y: auto;
            background: #fafafa;
        }
        .topic-modal-body {
            margin-top: 32px;
        }
        .topic-tree ul {
            list-style: none;
            padding-left: 20px;
        }
        .topic-tree li {
            margin: 2px 0;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .topic-tree label {
            cursor: pointer;
            display: inline-flex;
            align-items: flex-start;
        }
        .tree-toggle {
            display: inline-block;
            width: 14px;
            text-align: center;
            margin-right: 6px;
            cursor: pointer;
            vertical-align: top;
            position: relative;
            top: -3px;
        }
        .topic-tree li.collapsed > ul {
            display: none;
        }
        .topic-tree input[type=checkbox] {
            width: 18px;
            height: 18px;
            margin-right: 6px;
            margin-top: -2px;
        }
        .toolbar-right {
            float: right;
            display: flex;
            gap: 8px;
        }
        .tag-inline-input {
            display: inline-block;
            box-sizing: border-box;
        }
        .editable-cell,
        .editable-tag {
            width: 100%;
            box-sizing: border-box;
        }
        .single-tab {
            display: block;
        }
        .invalid {
            border: 1px solid red !important;
        }
        .topic-toolbar {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
            justify-content: flex-start;
        }
        .topic-toolbar .topic-search-wrapper .topic-search-input {
            flex: 1;
            padding: 8px 10px;
            border: none;
            border-radius: 0 6px 6px 0;
            outline: none;
            color: #333;
            font-size: 14px;
            box-shadow: none;
            height: 36px;
            box-sizing: border-box;
        }
        .topic-highlight {
            color: #94C518;
            font-weight: bold;
        }
        .topic-search-wrapper {
            display: flex;
            align-items: center;
            gap: 0;
            flex: 1;
            max-width: 520px;
            min-width: 260px;
            border: 1px solid #cfcfcf;
            border-radius: 6px;
            overflow: hidden;
            background: #fff;
        }
        .topic-search-icon-box {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            border: none;
            background: #f7f7f7;
            height: 36px;
            box-sizing: border-box;
            color: #777;
            min-width: 40px;
            border-right: 1px solid #cfcfcf;
        }
        .topic-search-icon {
            font-size: 16px;
            opacity: 0.8;
        }
       
    </style>
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> <span data-i18n="supmodel.label_name"></span></label>
        <input type="text" id="node-config-input-name" data-i18n="[placeholder]supmodel.label_name"/>
    </div>
    <div id="node-config-supmodel-tabs-content" style="min-height:150px;min-width: 1000px;">	
        <div id="supmodel-tab-mappings" class="single-tab">
            <div class="form-row">
                <label for="node-select-protocol"><i class="fa fa-cog"></i> <span data-i18n="supmodel.label_protocol"></label>
                <select type="text" id="node-select-protocol" class="select-protocol" style="width: calc(100% - 300px);">
                    <option value=""></option>
                    <option value="opcua">OPC UA</option>
                    <option value="opcda">OPC DA</option>
                    <option value="modbus">Modbus</option>
                    <option value="mqtt">MQTT</option>
                    <option value="mock">Direct</option>
                </select>
            </div>
            <div class="form-row">
                <input id="node-file-item" type="file" name="filename" accept=".json" style="display:none"/>
                <button class="editor-button" id="node-btn-select-topic"><i class="fa fa-cube"></i> <span data-i18n="supmodel.btn_select_topic"></span></button>
                <button class="editor-button" id="node-btn-item-add"><i class="fa fa-plus"></i> <span data-i18n="supmodel.label_add_one"></span></button>
                <button class="editor-button" id="node-btn-item-remove"><i class="fa fa-trash"></i> <span data-i18n="supmodel.label_delete_all"></span></button>
                <button class="editor-button" id="node-btn-item-dowbload"><i class="fa fa-arrow-circle-o-down"></i> <span data-i18n="supmodel.label_download_template"></span></button>
                <span class="toolbar-right">
                    <button class="editor-button" id="node-btn-item-export"><i class="fa fa-download"></i> <span data-i18n="supmodel.label_export"></span></button>
                    <button class="editor-button" id="node-btn-item-import"><i class="fa fa-upload"></i> <span data-i18n="supmodel.label_import"></span></button>
                </span>
            </div>
            <div id="node-table-models-form" style="margin-top:15px;border:1px solid #ddd;padding:10px">
                <table class="node-table-models">
                    <colgroup>
                        <col class="col-serial">
                        <col class="col-topic">
                        <col class="col-attr-name">
                        <col class="col-attr-type">
                        <col class="col-tag">
                        <col class="col-operation">
                    </colgroup>
                    <thead id="preview-thead">
                        <tr>
                            <th data-i18n="supmodel.table_header_serial"></th>
                            <th><span style="color:red">*</span> <span data-i18n="supmodel.table_header_topic"></span></th>
                            <th><span style="color:red">*</span> <span data-i18n="supmodel.table_header_prop_name"></span></th>
                            <th data-i18n="supmodel.table_header_prop_type"></th>
                            <th><span style="color:red">*</span> <span data-i18n="supmodel.table_header_tag_name"></span></th>
                            <th data-i18n="supmodel.table_header_operate"></th>
                        </tr>
                    </thead>
                    <tbody id="preview-tbody"></tbody>
                </table>
            </div>

            <div id="topic-modal" class="topic-modal" style="display:none;">
                <div class="topic-modal-content">
                    <div class="topic-modal-header">
                        <span data-i18n="supmodel.modal_select_topic"></span>
                        <div style="float:right;">
                            <button class="editor-button" id="topic-refresh"><i class="fa fa-refresh"></i></button>
                            <button class="editor-button" id="topic-close"><i class="fa fa-close"></i></button>
                        </div>
                    </div>
                    <div class="topic-modal-body">
                        <div class="topic-toolbar">
                            <button class="editor-button" id="topic-select-all" style="margin-bottom:5px;" data-i18n="supmodel.btn_select_all"></button>
                            <div class="topic-search-wrapper">
                                <span class="topic-search-icon-box"><i class="fa fa-search topic-search-icon"></i></span>
                                <input type="text" id="topic-search-input" class="topic-search-input" placeholder="Please enter name/alias/path" />
                            </div>
                        </div>
                        <div id="topic-tree" class="topic-tree"></div>
                    </div>
                    <div class="topic-modal-footer" style="text-align:right;margin-top:10px;">
                        <button class="editor-button" id="topic-confirm"><i class="fa fa-check"></i> <span data-i18n="supmodel.btn_ok"></span></button>
                    </div>
                </div>
            </div>

            <!-- 分页控件 -->
            <div class="pagination-control form-row">
                <span class="pagination-info" style="float: left;"><span data-i18n="supmodel.label_total"></span> <strong id="total-number">0</strong> <span data-i18n="supmodel.label_items"></span></span>
                <button class="pagination-btn prev" id="pagination-btn-prev" data-i18n="supmodel.page_previous"></button>
                <span class="pagination-info"><strong id="page-no">1</strong> / <strong id="total-pages"></strong> </span>
                <button class="pagination-btn next" id="pagination-btn-next" data-i18n="supmodel.page_next"></button>
            </div>

            
        </div>
    </div>
    
    
</script>

<script type="text/javascript"> 
(function() {
    // const lang = RED.i18n.detectLanguage();

    let firstLoad = false;
    const debugUseTestTree = false;

    const testTree = [
        {
            id: 'demo-factory-a',
            name: 'FactoryA',
            path: 'factoryA',
            pathType: 0,
            children: [
                {
                    id: 'demo-line1',
                    name: 'Line1',
                    path: 'factoryA/line1',
                    pathType: 0,
                    children: [
                        {
                            id: 'demo-motor1',
                            name: 'Motor1',
                            path: 'factoryA/line1/motor1',
                            pathType: 0,
                            children: [
                                { id: 'demo-motor1-power', name: 'Power', path: 'factoryA/line1/motor1/power', pathType: 1 },
                                { id: 'demo-motor1-temp', name: 'Temperature', path: 'factoryA/line1/motor1/temperature', pathType: 1 },
                                { id: 'demo-motor1-vibration', name: 'Vibration', path: 'factoryA/line1/motor1/vibration', pathType: 1 }
                            ]
                        },
                        {
                            id: 'demo-pump1',
                            name: 'Pump1',
                            path: 'factoryA/line1/pump1',
                            pathType: 0,
                            children: [
                                { id: 'demo-pump1-flow', name: 'Flow', path: 'factoryA/line1/pump1/flow', pathType: 1 },
                                { id: 'demo-pump1-pressure', name: 'Pressure', path: 'factoryA/line1/pump1/pressure', pathType: 1 }
                            ]
                        }
                    ]
                },
                {
                    id: 'demo-line2',
                    name: 'Line2',
                    path: 'factoryA/line2',
                    pathType: 0,
                    children: [
                        {
                            id: 'demo-line2-meter',
                            name: 'EnergyMeter',
                            path: 'factoryA/line2/energymeter',
                            pathType: 0,
                            children: [
                                { id: 'demo-line2-meter-voltage', name: 'Voltage', path: 'factoryA/line2/energymeter/voltage', pathType: 1 },
                                { id: 'demo-line2-meter-current', name: 'Current', path: 'factoryA/line2/energymeter/current', pathType: 1 },
                                { id: 'demo-line2-meter-power', name: 'Power', path: 'factoryA/line2/energymeter/power', pathType: 1 }
                            ]
                        },
                        {
                            id: 'demo-line2-robot',
                            name: 'RobotArm',
                            path: 'factoryA/line2/robotArm',
                            pathType: 0,
                            children: [
                                { id: 'demo-line2-robot-speed', name: 'Speed', path: 'factoryA/line2/robotArm/speed', pathType: 1 },
                                { id: 'demo-line2-robot-angle', name: 'Angle', path: 'factoryA/line2/robotArm/angle', pathType: 1 }
                            ]
                        }
                    ]
                },
                {
                    id: 'demo-line3',
                    name: 'Line3',
                    path: 'factoryA/line3',
                    pathType: 0,
                    children: [
                        { id: 'demo-line3-pack', name: 'Packaging', path: 'factoryA/line3/packaging', pathType: 0, children: [
                            { id: 'demo-line3-pack-count', name: 'Count', path: 'factoryA/line3/packaging/count', pathType: 1 },
                            { id: 'demo-line3-pack-rate', name: 'Rate', path: 'factoryA/line3/packaging/rate', pathType: 1 }
                        ]},
                        { id: 'demo-line3-qc', name: 'Quality', path: 'factoryA/line3/quality', pathType: 0, children: [
                            { id: 'demo-line3-qc-pass', name: 'PassRate', path: 'factoryA/line3/quality/passRate', pathType: 1 },
                            { id: 'demo-line3-qc-defect', name: 'Defect', path: 'factoryA/line3/quality/defect', pathType: 1 }
                        ]}
                    ]
                }
            ]
        },
        {
            id: 'demo-factory-b',
            name: 'PlantB',
            path: 'plantB',
            pathType: 0,
            children: [
                {
                    id: 'demo-b-line1',
                    name: 'Process1',
                    path: 'plantB/process1',
                    pathType: 0,
                    children: [
                        { id: 'demo-b-reactor-temp', name: 'ReactorTemp', path: 'plantB/process1/reactor/temp', pathType: 1 },
                        { id: 'demo-b-reactor-ph', name: 'ReactorPH', path: 'plantB/process1/reactor/ph', pathType: 1 },
                        { id: 'demo-b-reactor-level', name: 'ReactorLevel', path: 'plantB/process1/reactor/level', pathType: 1 }
                    ]
                },
                {
                    id: 'demo-b-line2',
                    name: 'Utilities',
                    path: 'plantB/utilities',
                    pathType: 0,
                    children: [
                        { id: 'demo-b-chiller', name: 'Chiller', path: 'plantB/utilities/chiller', pathType: 0, children: [
                            { id: 'demo-b-chiller-supply', name: 'SupplyTemp', path: 'plantB/utilities/chiller/supplyTemp', pathType: 1 },
                            { id: 'demo-b-chiller-return', name: 'ReturnTemp', path: 'plantB/utilities/chiller/returnTemp', pathType: 1 }
                        ]},
                        { id: 'demo-b-boiler', name: 'Boiler', path: 'plantB/utilities/boiler', pathType: 0, children: [
                            { id: 'demo-b-boiler-pressure', name: 'SteamPressure', path: 'plantB/utilities/boiler/pressure', pathType: 1 },
                            { id: 'demo-b-boiler-temp', name: 'SteamTemp', path: 'plantB/utilities/boiler/temp', pathType: 1 }
                        ]}
                    ]
                }
            ]
        }
    ];

    function createDynamicMqttBroker(RED) {
        
        const nodeId = "85bb67b2dbefe3ba"; // 要检查的节点ID
        
        RED.nodes.import([{
            "id": nodeId, // 固定ID
            "type": "mqtt-broker",
            "name": "emqx:1883",
            "broker": "emqx",
            "port": 1883,
            "clientid": "",
            "autoConnect": true,
            "usetls": false,
            "protocolVersion": "4",
            "keepalive": "60",
            "cleansession": true,
            "autoUnsubscribe": true,
            "birthTopic": "",
            "birthQos": "0",
            "birthRetain": "false",
            "birthPayload": "",
            "birthMsg": {},
            "closeTopic": "",
            "closeQos": "0",
            "closeRetain": "false",
            "closePayload": "",
            "closeMsg": {},
            "willTopic": "",
            "willQos": "0",
            "willRetain": "false",
            "willPayload": "",
            "willMsg": {},
            "userProps": "",
            "sessionExpiry": ""
        }], {
            // 冲突处理策略
            allowMissingNodes: true,  // 允许缺失节点类型
            reuseIds: false           // 强制生成新 ID 避免冲突
        });
    }

    const toSafeString = (value) => {
        if (value === undefined || value === null) {
            return '';
        }
        return (value + '').trim();
    };

    const sanitizeTagValue = (val) => {
        return (val || '').toString();
    };

    const buildRowKey = (row) => {
        if (!Array.isArray(row)) {
            return '';
        }
        return [row[0] || '', row[1] || '', row[2] || '', row[3] || '', row[4] || ''].join('|');
    };

    const buildUniqueKey = (row) => {
        if (!Array.isArray(row)) {
            return '';
        }
        return [row[0] || '', row[2] || ''].join('|'); // topic + attrName
    };

    const isRequiredCol = (colIdx) => {
        return colIdx === 0 || colIdx === 1 || colIdx === 3;
    };

    const validateRequiredInput = ($input) => {
        const colIdx = Number($input.data('col'));
        if (!isRequiredCol(colIdx)) {
            $input.removeClass('invalid');
            return true;
        }
        const val = ($input.val() || '').toString().trim();
        if (val === '') {
            $input.addClass('invalid');
            return false;
        }
        $input.removeClass('invalid');
        return true;
    };

    const attachRequiredHandlers = () => {
        $('#topic-modal .topic-tree input').removeClass('invalid'); // no-op for tree
        $('#supmodel-tab-mappings').find('input[data-col]').off('blur.required').on('blur.required', function() {
            validateRequiredInput($(this));
        });
    };

    const normalizeSingleMapping = (item) => {
        if (!item) {
            return null;
        }
        if (Array.isArray(item)) {
            return item;
        }
        const selector = toSafeString(item.tagConfiguration || item.TagConfiguration || item.selector || item.tag || item.target || item.topicIndex);
        const targetTopic = toSafeString(item.topic || item.Topic || item.targetTopic || item.path);
        const targetField = toSafeString(item.attributeName || item.AttributeName || item.targetField || item.propName || item.field || item.property);
        const alias = toSafeString(item.alias || item.targetAlias);
        const propType = toSafeString(item.attributeType || item.targetType || item.propType || item.type);
        if (!selector && !targetTopic && !targetField) {
            return null;
        }
        return [targetTopic, alias, targetField, propType, selector];
    };

    const normalizeMappingPayload = (payload) => {
        if (payload == null) {
            return [];
        }
        if (Array.isArray(payload)) {
            return payload.map(normalizeSingleMapping).filter(Boolean);
        }
        if (Array.isArray(payload.mapping)) {
            return payload.mapping.map(normalizeSingleMapping).filter(Boolean);
        }
        if (Array.isArray(payload.tags)) {
            return payload.tags.map(normalizeSingleMapping).filter(Boolean);
        }
        if (Array.isArray(payload.data)) {
            return payload.data.map(normalizeSingleMapping).filter(Boolean);
        }
        return [];
    };

    const convertRowsToMapping = (rows) => {
        if (!Array.isArray(rows)) {
            return [];
        }
        return rows.map(row => {
            return {
                tagConfiguration: row[4] !== undefined ? (row[4] + '') : '',
                topic: row[0] || '',
                attributeName: row[2] || '',
                attributeType: row[3] || ''
            }
        }).filter(item => item.tagConfiguration || item.topic || item.attributeName);
    };

    const normalizeRowData = (rowData) => {
        const topic = rowData[0] || '';
        const propName = rowData[1] || '';
        const propType = rowData[2] || '';
        const tag = sanitizeTagValue(rowData[3] || '');
        return [topic, '', propName, propType, tag]; // Alias占位，AttributeType可为空
    };

    const highlightLabel = (text, key) => {
        const labelText = text || '';
        const keyword = (key || '').trim();
        if (!keyword) {
            return labelText;
        }
        const escaped = keyword.replace(/[-/\\^$*+?.()|[\]{}]/g, '\\$&');
        const reg = new RegExp(escaped, 'gi');
        return labelText.replace(reg, match => `<span class="topic-highlight">${match}</span>`);
    };

    const filterTopicTree = (nodes, searchKey = '') => {
        const keyword = (searchKey || '').trim().toLowerCase();
        if (!keyword) {
            return nodes || [];
        }
        const matchNode = (node) => {
            const text = [
                node.path,
                node.topic,
                node.alias,
                node.name,
                node.label
            ].find(Boolean) || '';
            return text.toString().toLowerCase().includes(keyword);
        };
        const loop = (list) => {
            return (list || []).map(n => {
                const children = loop(n.children || n.childrens || []);
                if (matchNode(n) || children.length > 0) {
                    return Object.assign({}, n, { children });
                }
                return null;
            }).filter(Boolean);
        };
        return loop(nodes);
    };

    const buildTreeHtml = (nodes, level = 0, searchKey = '') => {
        if (!nodes || nodes.length === 0) {
            return '';
        }
        return `<ul>${nodes.map(n => {
            const childrenHtml = buildTreeHtml(n.children || n.childrens || [], level + 1, searchKey);
            const topic = n.path || n.topic || n.alias || '';
            const alias = n.alias || '';
            const label = n.name || n.label || topic;
            const renderedLabel = highlightLabel(label, searchKey);
            const id = (n.id || topic || Math.random().toString(16).slice(2));
            const hasChild = childrenHtml ? 'has-child' : 'leaf';
            const nodeType = (typeof n.pathType !== 'undefined') ? n.pathType : n.type;
            const typeIcon = nodeType === 0 ? '<i class="fa fa-folder-o" style="margin-right:6px;"></i>' : '<i class="fa fa-file-text-o" style="margin-right:6px;"></i>';
            const toggle = childrenHtml ? `<span class="tree-toggle" data-toggle="1">&#9654;</span>` : `<span class="tree-toggle"></span>`;
            const collapsedClass = childrenHtml ? 'collapsed' : '';
            return `<li class="${hasChild} ${collapsedClass}" data-level="${level}">
                ${toggle}<label><input type="checkbox" class="topic-check" data-topic="${topic}" data-alias="${alias}" data-label="${label}" data-id="${id}" data-haschild="${childrenHtml ? '1':'0'}" data-type="${(nodeType === 0 || nodeType === 1 || nodeType === 2) ? nodeType : ''}"/>${typeIcon}<span class="tree-label">${renderedLabel}</span></label>
                ${childrenHtml}
            </li>`;
        }).join('')}</ul>`;
    };

    const expandAllTreeNodes = () => {
        $('#topic-tree li.collapsed').removeClass('collapsed');
        $('#topic-tree .tree-toggle[data-toggle]').html('&#9660;');
    };

    const renderTopicTree = (data, searchKey = '') => {
        $('#topic-tree').html(buildTreeHtml(data, 0, searchKey));
        bindTopicCheckboxEvents();
        bindToggleEvents();
        if ((searchKey || '').trim()) {
            expandAllTreeNodes();
        }
    };

    const bindTopicCheckboxEvents = () => {
        $('#topic-tree .topic-check').off('change').on('change', function() {
            const checked = $(this).is(':checked');
            const $li = $(this).closest('li');
            // propagate to children
            $li.find('.topic-check').prop('checked', checked);
            // propagate to ancestors: if any child checked -> parent checked, else unchecked
            $li.parents('li').each(function() {
                const anyChecked = $(this).find('> ul .topic-check:checked').length > 0;
                $(this).children('label').find('.topic-check').prop('checked', anyChecked);
            });
        });
    };

    const bindToggleEvents = () => {
        $('#topic-tree .tree-toggle[data-toggle]').off('click').on('click', function(e) {
            e.stopPropagation();
            const $li = $(this).closest('li');
            if ($li.hasClass('collapsed')) {
                $li.removeClass('collapsed');
                $(this).html('&#9660;'); // down
            } else {
                $li.addClass('collapsed');
                $(this).html('&#9654;'); // right
            }
        });
    };

    const uploadJson = (node, file) => {
        const formData = new FormData();
        formData.append("file", file);
        
        $.ajax({
            url: '/nodered-api/upload/tags?nodeId=' + node.id,
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            beforeSend: function() {
                $('#errorMsg').empty();
            },
            success: function(res) {
                const normalized = normalizeMappingPayload(res.data);
                const finalData = normalized.length > 0 ? normalized : res.data;
                templateModels[node.id] = finalData;
                rowEditable[node.id] = new Array(finalData.length).fill(true);

                pagenation.pageNo = 1;
                pagenation.totalNumber = templateModels[node.id].length;
                pagenation.pageTotal = Math.ceil(templateModels[node.id].length / pagenation.pageItem);
                // 截取前20条展示
                const renderData = templateModels[node.id].slice(0, pagenation.pageItem);
                renderTable(node, renderData);
            },
            error: function(err) {
                console.log(err);
                const errorMsg = node._('supmodel.network_error');
                alert(err.responseText || errorMsg);
            }
        });
    }

    const saveTags = (node, data) => {
        if (!data) {
            return;
        }
        $.ajax({
            url: `/nodered-api/save/tags`,
            type: 'POST',
            data: JSON.stringify({
                nodeId: node.id,
                tags: data
            }),
            contentType: "application/json",
            beforeSend: function() {
                $('#errorMsg').empty();
            },
            success: function(res) {
                
            },
            error: function(err) {
                console.log("save/tags error:");
                console.log(err);
                RED.notify('System Error: Save Tags Failed!', "error");
            }
        });
    }

    const loadTags = (nodeId) => {
        $.ajax({
            url: '/nodered-api/query/tags?nodeId=' + nodeId,
            type: 'GET',
            async: false,
            beforeSend: function() {
                $('#errorMsg').empty();
            },
            success: function(res) {
                if (res.data) {
                    const normalized = normalizeMappingPayload(res.data);
                    templateModels[nodeId] = normalized.length > 0 ? normalized : res.data;
                    rowEditable[nodeId] = new Array(templateModels[nodeId].length).fill(false);
                }
            },
            error: function(err) {
                console.log(err);
                RED._debug('tags load failed')
            }
        });
    }


    const renderTable = (node, data) => {
        $('#preview-tbody tbody').empty();
        // 渲染数据行
        $('#preview-tbody').html(
            data.map((row, index) => {
                        let start  = (pagenation.pageNo - 1) * pagenation.pageItem;
                        let id = start + index + 1;
                        const globalIdx = id - 1;
                        const editableRow = rowEditable[node.id] && rowEditable[node.id][globalIdx] === true;
                        const displayRow = [
                            row[0],
                            row[2],
                            row[3],
                            row[4]
                        ];
                        return `<tr data-row="${index}"><td>${id}</td>${displayRow.map((cell, idx) => {
                            const isTagCol = idx === 3;
                            const val = cell == null ? '' : cell;
                            const requiredClass = isRequiredCol(idx) ? ' required-input' : '';
                            if (editableRow || isTagCol) {
                                const inputClass = isTagCol ? 'tag-inline-input editable-tag' : 'editable-cell';
                                return `<td><input type="text" class="${inputClass}${requiredClass}" value="${val}" data-col="${idx}"/></td>`;
                            }
                            return `<td class="cell" data-col="${idx}" title="${val}">${val}</td>`;
                        }).join('')}<td><i class="fa fa-remove remove" title='delete'></i></td></tr>`
                    }
            ).join('')
        );
        // 填充分页信息
        $('#page-no').text(pagenation.pageNo);
        $('#total-pages').text(pagenation.pageTotal);
        $('#total-number').text(pagenation.totalNumber);
        //注册删除和修改事件
        // $('.edit').on('click', function() {
        //     if ($(this).hasClass('fa-pencil')) {

        //         $(this).removeClass("fa-pencil").addClass("fa-check");
        //         const len = $(this).closest('tr').find('td').length;

        //         $(this).closest('tr').find('td').each(function(index) {
        //             const val = $(this).text();
        //             // 为了去掉头尾，取值中间项
        //             if (index < (len-1) && index > 0) {
        //                 if (index == (len-2)) {
        //                     $(this).html(`<input type="text" value="${val}" style="width: 100%"/>`)
        //                 } else {
        //                     $(this).html(`<input disabled type="text" value="${val}" style="width: 100%"/>`)
        //                 }
        //             }
        //         });
        //     } else {
        //         let id = $(this).closest('tr').find("td:first").text();

        //         $(this).removeClass("fa-check").addClass("fa-pencil");
                
        //         const len = $(this).closest('tr').find('td').length;

        //         $(this).closest('tr').find('td').each(function(index) {
        //             const val = $(this).find('input, select').val();
        //             // 为了去掉头尾，取值中间项
        //             if (index < (len-1) && index > 0) {
        //                 $(this).text(val);
        //             }
        //         });
        //         const rowData = $(this).closest('tr').map(function() {
        //             return $(this).find("td").map(function(index) {
        //                 // 为了去掉头尾，取值中间项
        //                 if (index < (len-1) && index > 0) {
        //                     return $(this).text();
        //                 }
        //             }).get();
        //         }).get();

        //         const normalized = normalizeRowData(rowData);
        //         templateModels[node.id][id - 1] = normalized;
        //     }
            
        // });

        $('.remove').on('click', function() {
            let id = $(this).closest('tr').find("td:first").text();
            // 删除数组中元素
            templateModels[node.id].splice(id - 1, 1);
            if (rowEditable[node.id]) {
                rowEditable[node.id].splice(id - 1, 1);
            }
            
            // 重新渲染表格
            let start  = (pagenation.pageNo - 1) * pagenation.pageItem;
            let renderNewData = templateModels[node.id].slice(start, (start + pagenation.pageItem));

            pagenation.pageTotal = Math.ceil(templateModels[node.id].length / pagenation.pageItem);
            pagenation.totalNumber -= 1;

            if (renderNewData.length == 0) {
                resetPage();
                start  = (pagenation.pageNo - 1) * pagenation.pageItem;
                renderNewData = templateModels[node.id].slice(start, (start + pagenation.pageItem));
            }
            renderTable(node, renderNewData);
        });

        $('.editable-cell').on('input', function() {
            const rowIdx = $(this).closest('tr').data('row');
            const colIdx = Number($(this).data('col'));
            let current = templateModels[node.id][(pagenation.pageNo -1)*pagenation.pageItem + rowIdx] || ['', '', '', '', ''];
            switch(colIdx) {
                case 0: current[0] = $(this).val(); break;
                case 1: current[2] = $(this).val(); break;
                case 2: current[3] = $(this).val(); break;
                case 3: current[4] = $(this).val(); break;
            }
            templateModels[node.id][(pagenation.pageNo -1)*pagenation.pageItem + rowIdx] = current;
            validateRequiredInput($(this));
        });
        $('.editable-tag').on('input', function() {
            const rowIdx = $(this).closest('tr').data('row');
            const globalIdx = (pagenation.pageNo -1)*pagenation.pageItem + rowIdx;
            let current = templateModels[node.id][globalIdx] || ['', '', '', '', ''];
            const newVal = sanitizeTagValue($(this).val());
            current[4] = newVal;
            templateModels[node.id][globalIdx] = current;
            validateRequiredInput($(this));
        });

    };

    let timeoutId;

    const delayShowFileDropList = (node) => {
        var searchParam = ($('.search-input-m').val() || '').trim();
            // 清除之前的定时器
        clearTimeout(timeoutId);
        // 设置新的定时器
        timeoutId = setTimeout(() => {
            showFileDropList(node, searchParam);
        }, 600); 
        
    }

    // 显示uns文件下拉列表
    const showFileDropList = (node, inputParam) => {
        const keyword = (inputParam || '').trim();
        var encodeUrl = encodeURI(`/inter-api/supos/uns/search?k=${keyword}&pageNo=1&pageSize=100&orderBy=createTime&type=2&normal=true`);
        $.ajax({
            url: encodeUrl,
            type: 'GET',
            dataType: 'json',
            beforeSend: function() {
                $('#errorMsg').empty();
            },
            success: function(data) {
                if (data.code == 200 || data.code == 0) {
                    showFiles(node, data.data);
                } else {
                    showFiles(node, []);
                    $('#errorMsg').html('<p style="color: red;">' + data.msg || 'sever error' + '</p>');
                }
                
            },
            error: function(err) {
                showFiles(node, []);
                $('#errorMsg').html('<p style="color: red;">network error</p>');
            }
        });
    };

    const showFiles = (node, files) => {
        $('#dropdownOptions').empty();
        if (files && files.length > 0) {
            files.forEach(m => {
                $('#dropdownOptions').append(`<div dataAlias="${m.alias}" dataId="${m.id}" dataTopic="${m.path}">${m.path}</div>`);
            });
            // 点击选项后关闭下拉框
            $('#dropdownOptions div').on('click', function() {
                let path = $(this).attr('dataTopic');
                let alias = $(this).attr('dataAlias');
                let id = $(this).attr('dataId');
                $('.search-input-m').val(path);
                $('#dropdownOptions').css('display', 'none');
                node.selectedModelAlias = alias;
                // 查询文件属性，并跳转到位号映射标签页
                queryFileDetail(id, alias, path, node);
            });
        } else {
            $('#dropdownOptions').append('<div id="nodataOption" style="align:center;" value="">-- No Data --</div>');
        }
        $('#dropdownOptions').css('display', 'block');
    };

    const openTopicModal = (node) => {
        $('#topic-modal').show();
        loadTopicTree(node, ($('#topic-search-input').val() || '').trim());
    };

    const loadTopicTree = (node, searchKey = '') => {
        const normalizedKey = (searchKey || '').trim();
        if (debugUseTestTree) {
            if (!topicTreeCache.length) {
                topicTreeCache = testTree;
            }
            const renderData = filterTopicTree(topicTreeCache, normalizedKey);
            renderTopicTree(renderData, normalizedKey);
            return;
        }
        $.ajax({
            url: '/inter-api/supos/uns/tree',
            type: 'GET',
            dataType: 'json',
            data: {
                key: normalizedKey || ''
            },
            success: function(res) {
                const resData = Array.isArray(res && res.data) ? res.data : (Array.isArray(res) ? res : []);
                if (!normalizedKey) {
                    topicTreeCache = resData;
                }
                const sourceData = normalizedKey ? resData : (topicTreeCache || []);
                const filteredData = filterTopicTree(sourceData, normalizedKey);
                renderTopicTree(filteredData, normalizedKey);
            },
            error: function(err) {
                console.log(err);
                RED.notify('Load topic tree failed', "error");
            }
        });
    };
        
    const queryFileDetail = (id, alias, path, node) => {
        var encodeUrl = encodeURI(`/inter-api/supos/uns/instance?id=${id}`);
        $.ajax({
            url: encodeUrl,
            type: 'GET',
            dataType: 'json',
            success: function(data) {
                if (data.code == 200 || data.code == 0) {
                    templateModels[node.id] = [];
                    let i = 0;
                    if (node.protocol == 'mqtt') {
                        templateModels[node.id].push([data.data.path, alias, '', '', i+'']);
                    } else {
                        data.data.fields.map((f, index) => {
                            // const lastSlashIndex = data.data.path.lastIndexOf('/');
                            // let folder = lastSlashIndex !== -1 ? data.data.path.substring(0, (lastSlashIndex+1)) : ''; 
                            if (!f.systemField) { // 排除系统字段
                                const fieldName = f.name || f.attributeName || f.fieldName || "";
                                const rawType = f.type || f.attributeType || f.fieldType || "";
                                const fieldType = (rawType || "").toString().toLowerCase();
                                templateModels[node.id].push([data.data.path, alias, fieldName, fieldType, i+'']);
                                i += 1;
                            }
                        });
                    }
                    pagenation.pageNo = 1;
                    pagenation.totalNumber = templateModels[node.id].length;
                    pagenation.pageTotal = Math.ceil(templateModels[node.id].length / pagenation.pageItem);

                    // 切换到位号映射标签，并填充表格
                    const renderData = templateModels[node.id].slice(0, pagenation.pageItem);
                    renderTable(node, renderData);
                }
            },
            error: function(err) {
                console.log(err);
            }
        });
    }

    const checkTable = (node, rowsData) => {
        // 文件名称正则
        const regFileName = /^[\u4e00-\u9fa5a-zA-Z0-9_-]+$/
        // 属性名称正则
        const regFieldName =  /^[A-Za-z][A-Za-z0-9_]*$/
        const allowedAttrTypes = ["integer", "long", "double", "float", "boolean", "datetime", "string"];

        for (let i in rowsData) {
            const [path, alias, fname, ftype, tag] = rowsData[i];
            // 校验必填字段
            if (!path) {
                return node._("supmodel.error_path_not_null")
            }
            if (node.protocol !== 'mqtt') {
                if (!fname) {
                    return node._("supmodel.error_field_not_null")
                }
                // AttributeType 可为空，不校验
                if (!regFieldName.test(fname)) {
                    return node._("supmodel.error_invalid_fieldname")
                }
                if (ftype) {
                    const lowerType = (ftype || "").toString().toLowerCase().trim();
                    if (allowedAttrTypes.indexOf(lowerType) === -1) {
                        return node._("supmodel.error_invalid_type");
                    }
                }
            }
            if (!tag || tag == null || tag == undefined) {
                return node._("supmodel.error_tag_not_null")
            }
            // 校验folder path不能以/开头
            if (path && path.startsWith("/")) {
                return node._("supmodel.error_invalid_folder_path")
            }
            // 长度校验
            // if (name.length > 63 || (alias && alias.length > 63)) {
            //     return node._("supmodel.label_serial") + ` ${index} ` + node._("supmodel.label_data_error") + ": " + node._("supmodel.error_execeed_max_length")
            // }
            // 正则校验
            // if (!regFileName.test(name)) {
            //     return node._("supmodel.label_serial") + ` ${index} ` + node._("supmodel.label_data_error") + ": " + node._("supmodel.error_invalid_filename")
            // }
            
        }
        return "";
        
    }

    let detachDoneGuard = null;
    const clearDoneGuard = () => {
        if (detachDoneGuard) {
            detachDoneGuard();
        }
    };
    const bindDoneGuard = (node) => {
        const okButton = document.getElementById("node-dialog-ok");
        if (!okButton) {
            return;
        }
        clearDoneGuard();
        const handler = (evt) => {
            const models = templateModels[node.id] || [];
            const prevProtocol = node.protocol;
            const selectedProtocol = $('#node-select-protocol').val();
            if (selectedProtocol !== undefined) {
                node.protocol = selectedProtocol;
            }
            let msg = "";
            try {
                msg = checkTable(node, models);
            } finally {
                node.protocol = prevProtocol;
            }
            if (msg) {
                evt.preventDefault();
                evt.stopImmediatePropagation();
                evt.stopPropagation();
                RED.notify(msg, "error");
                return false;
            }
            return true;
        };
        okButton.addEventListener('click', handler, true);
        detachDoneGuard = () => {
            okButton.removeEventListener('click', handler, true);
            detachDoneGuard = null;
        };
    };

    RED.events.on("editor:close", clearDoneGuard);
    
    let pagenation = 
    {
            pageNo: 1,
            pageTotal: 0,
            pageItem: 10,
            totalNumber: 0
    };

    const resetPage = () => {
        pagenation = 
        {
            pageNo: 1,
            pageTotal: 0,
            pageItem: 10,
            totalNumber: 0
        };
    }
    let templateModels = {};
    let rowEditable = {};
    let tabs;
    let topicTreeCache = [];
    
    RED.nodes.registerType('supmodel', {
        category: 'supnodes',
        color: '#66CDAA',
        defaults: {
            name: {
                value: ""
            },
            protocol: {
                value: ""
            },
            selectedModel: {
                value: ""
            },
            selectedModelAlias: {
                value: ""
            },
            mapping: {
                value: []
            },
            modelShowName: {
                value: ""
            },
            tableValid: {
                value: true,
                // validate: function(v, opt) {
                //     const nodeId = this.id;
                //     const models = templateModels[nodeId] || [];
                //     const msg = checkTable(this, models);
                //     if (msg) {
                //         RED.notify(msg, "error");
                //         return false;
                //     }
                //     return true;
                // }
            },
            interval: {
                value: 100
            }
        },
        inputs: 1,
        outputs: 1,
        icon: "font-awesome/fa-cubes",
        label: function () {
            if (this.name) {
                return this.name;
            }
            if (this.selectedModel) {
                return this.selectedModel;
            }
            if (this.modelShowName) {
                return this.modelShowName;
            }
            return this._('supmodel.node_name');
            
        },
        paletteLabel: function () {
            return this._('supmodel.node_name');
        },
        oneditprepare: function () {
            const node = this;
            let thisModels = templateModels[node.id];
            if (!thisModels || thisModels.length == 0) {
                loadTags(node.id)
                thisModels = templateModels[node.id];
            }
            if ((!thisModels || thisModels.length == 0) && node.mapping) {
                const normalized = normalizeMappingPayload(node.mapping);
                if (normalized.length > 0) {
                    templateModels[node.id] = normalized;
                    rowEditable[node.id] = new Array(normalized.length).fill(false);
                }
            }
            if (!rowEditable[node.id]) {
                rowEditable[node.id] = new Array((templateModels[node.id] || []).length).fill(false);
            }

            bindDoneGuard(node);

            $("#node-config-supmodel-tabs-content").children().hide();
            $("#supmodel-tab-mappings").show();

            // 设置协议
            if (node.protocol) {
                $('#node-select-protocol').val(node.protocol);
            }
            // 设置名称
            $('#node-config-input-name').val(node.name);

            // 注册模型选择事件
            $('#node-input-selectedModel').on('focus', function() {
                showFileDropList(node, $(this).val());
            })
            $('#node-input-selectedModel').on('input', function() {
                delayShowFileDropList(node);
            })
            // 初始化全屏控件
            

            // 点击外部区域关闭下拉框
            document.addEventListener('click', function(event) {
                const dropdown = document.getElementById("dropdownOptions");
                const input = document.querySelector(".search-input-m");
                if (dropdown && !dropdown.contains(event.target) && event.target !== input) {
                    dropdown.style.display = "none";
                    $('#errorMsg').empty();
                }
            });

            let importBtn = $("#node-btn-item-import");
            let exportBtn = $("#node-btn-item-export");
            let downloadBtn = $("#node-btn-item-dowbload");
			let removeBtn = $("#node-btn-item-remove");
            let addBtn = $("#node-btn-item-add");
			let itemFile = $("#node-file-item");	
			
            
			importBtn.click(function() {
				itemFile.click();
			});

            downloadBtn.click(function() {
				// window.location.href="/nodered-api/download/template";
                window.open("/nodered-api/download/template");
			});

            exportBtn.click(function() {
				// window.location.href="/nodered-api/download/template";
                window.open(`/nodered-api/export/tags?nodeId=${node.id}`);
			});

            $('#node-btn-select-topic').click(function() {
                openTopicModal(node);
            });

            $('#topic-refresh').click(function() {
                const key = ($('#topic-search-input').val() || '').trim();
                loadTopicTree(node, key);
            });

            $('#topic-close').click(function() {
                $('#topic-modal').hide();
            });

            $('#topic-select-all').click(function() {
                const checked = $(this).data('checked') === true;
                $('#topic-tree .topic-check').prop('checked', !checked).trigger('change');
                $(this).data('checked', !checked);
            });

            let topicSearchTimer = null;
            const triggerSearch = () => {
                clearTimeout(topicSearchTimer);
                topicSearchTimer = setTimeout(() => {
                    const key = ($('#topic-search-input').val() || '').trim();
                    if (!key) {
                        if (topicTreeCache && topicTreeCache.length > 0) {
                            renderTopicTree(topicTreeCache, '');
                        } else {
                            loadTopicTree(node, '');
                        }
                        return;
                    }
                    loadTopicTree(node, key);
                }, 700);
            };
            $('#topic-search-input').on('input', function() {
                triggerSearch();
            });

            $('#topic-confirm').click(function() {
                const checkedNodes = [];
                $('#topic-tree .topic-check:checked').each(function() {
                    const hasChild = $(this).data('haschild') === '1';
                    const nestedChecked = $(this).closest('li').find('ul .topic-check:checked').length;
                    if (hasChild && nestedChecked > 1) {
                        return; // prefer leaf nodes when parent selected with children
                    }
                    const topic = $(this).data('topic') || '';
                    const label = $(this).data('label') || topic;
                    const id = $(this).data('id') || '';
                    const alias = $(this).data('alias') || '';
                    checkedNodes.push({topic, label, id, alias});
                });

                if (checkedNodes.length === 0) {
                    $('#topic-modal').hide();
                    return;
                }

                const requests = checkedNodes.map(item => {
                    return $.ajax({
                        url: `/inter-api/supos/uns/instance?id=${encodeURIComponent(item.id)}`,
                        type: 'GET',
                        dataType: 'json'
                    }).then(data => ({item, data}), err => ({item, error: err}));
                });

                Promise.all(requests).then(resArr => {
                    if (!templateModels[node.id]) {
                        templateModels[node.id] = [];
                    }
                    if (!rowEditable[node.id]) {
                        rowEditable[node.id] = [];
                    }
                    let start = templateModels[node.id].length;
                    const existingKeys = new Set(templateModels[node.id].map(buildUniqueKey));
                    resArr.forEach((resWrap, idx) => {
                        const item = resWrap.item;
                        const data = resWrap.data;
                        if (resWrap.error || !data || !data.data) {
                            return;
                        }
                        const body = data.data;
                        const alias = item.alias || body.alias || '';
                        if (node.protocol == 'mqtt') {
                            const row = [body.path || item.topic, alias, '', '', (start + idx)+''];
                            const key = buildUniqueKey(row);
                            if (!existingKeys.has(key)) {
                                templateModels[node.id].push(row);
                                rowEditable[node.id].push(false);
                                existingKeys.add(key);
                            }
                        } else if (Array.isArray(body.fields)) {
                            body.fields.forEach((f, fi) => {
                                if (f.systemField) {
                                    return;
                                }
                                const fieldName = f.name || f.attributeName || f.fieldName || "";
                                const rawType = f.type || f.attributeType || f.fieldType || "";
                                const fieldType = (rawType || "").toString().toLowerCase();
                                const tagVal = (start + idx + fi).toString();
                                const row = [body.path || item.topic, alias, fieldName, fieldType, tagVal];
                                const key = buildUniqueKey(row);
                                if (!existingKeys.has(key)) {
                                    templateModels[node.id].push(row);
                                    rowEditable[node.id].push(false);
                                    existingKeys.add(key);
                                }
                            });
                        }
                    });
                    pagenation.totalNumber = templateModels[node.id].length;
                    pagenation.pageTotal = Math.ceil(templateModels[node.id].length / pagenation.pageItem);
                    const renderData = templateModels[node.id].slice(0, pagenation.pageItem);
                    renderTable(node, renderData);
                }).finally(() => {
                    $('#topic-modal').hide();
                });
            });

            addBtn.click(function() {
                if ($('#preview-tbody .dirty').length > 0) {
                    return;
                }
                let len = $('#preview-thead').find('th').length;
                $('#preview-tbody').prepend("<tr class='dirty'><td>0</td></tr>")
                // 掐头去尾
                for (let i = 1; i < len -1; i++) {
                    $('#preview-tbody .dirty').append(`<td><input type="text" style="width: 100%" data-col="${i-1}" class="${isRequiredCol(i-1)?'required-input':''}"/></td>`)
                }
                $('#preview-tbody .dirty').append('<td><i class="fa fa-remove remove"></i></dt>');
                const applyInsert = () => {
                    const rowData = $('#preview-tbody .dirty').map(function() {
                        return $(this).find("input").map(function(index) {
                            return $(this).val();
                        }).get();
                    }).get();
                    const normalized = normalizeRowData(rowData);
                    if (!templateModels[node.id]) {
                        templateModels[node.id] = [];
                    }
                    if (!rowEditable[node.id]) {
                        rowEditable[node.id] = [];
                    }
                    templateModels[node.id].unshift(normalized);
                    rowEditable[node.id].unshift(true);
                    pagenation.totalNumber += 1;
                    pagenation.pageTotal = Math.ceil(templateModels[node.id].length / pagenation.pageItem);
				    renderTable(node, templateModels[node.id]);
                    attachRequiredHandlers();
                };
                $('#preview-tbody .dirty input').on('change', function() {
                    applyInsert();
                });
                $('#preview-tbody .dirty .remove').on('click', function() {
                    $(this).closest('tr').remove();
                });
            });
			
            removeBtn.click(function() {
                resetPage();
                templateModels[node.id] = [];
                rowEditable[node.id] = [];
				renderTable(node, templateModels[node.id]);
			});
			
			$('#node-file-item').on('change', function(e) {
                uploadJson(node, e.target.files[0]); // 获取选中的文件
                $(this).val('');
            });

            // 注册上一页点击事件
            $('#pagination-btn-prev').on('click', function() {
                if (pagenation.pageNo <= 1) {
                    return;
                }
                pagenation.pageNo -= 1;
                // 截取前20条展示
                const start  = (pagenation.pageNo - 1) * pagenation.pageItem;
                const renderData = templateModels[node.id].slice(start, (start + pagenation.pageItem));
                renderTable(node, renderData);
            });

            // 注册下一页点击事件
            $('#pagination-btn-next').on('click', function() {
                if (pagenation.pageNo >= pagenation.pageTotal) {
                    return;
                }
                pagenation.pageNo += 1;
                // 截取前20条展示
                const start  = (pagenation.pageNo - 1) * pagenation.pageItem;
                const renderData = templateModels[node.id].slice(start, (start + pagenation.pageItem));
                renderTable(node, renderData);
            });
            if (!templateModels[node.id]) {
                templateModels[node.id] = [];
            }
            if (!rowEditable[node.id]) {
                rowEditable[node.id] = new Array(templateModels[node.id].length).fill(false);
            }
            pagenation.pageTotal = Math.ceil(templateModels[node.id].length / pagenation.pageItem);
            pagenation.totalNumber = templateModels[node.id].length;

            // 渲染表格
            const renderData = templateModels[node.id].slice(0, pagenation.pageItem);
            renderTable(node, renderData);
        },
        oneditcancel: function () {
            clearDoneGuard();
        },
        oneditsave: function () {
            console.log("oneditsave called");
            const node = this;
            clearDoneGuard();
            node.selectedModel = $('.search-input-m').val();
            if (!node.selectedModel) {
                node.selectedModelAlias = "";
            }

            node.protocol = $('#node-select-protocol').val();
            node.name =  $('#node-config-input-name').val();

            pagenation.pageNo = 1;

            let thisModels = templateModels[node.id] || [];
            templateModels[node.id] = thisModels;

            let errorMsg = checkTable(node, thisModels);
            if (errorMsg) {
                node.tableValid = false;
                // RED.notify(errorMsg, "error");
                RED._debug(errorMsg)
                return false; // 阻止编辑框关闭
            }
            node.tableValid = true;

            this.modelShowName = thisModels && thisModels.length > 0 ? thisModels[0][0] : "";
            if (this.modelShowName) {
                let selectedPrefix = this._('supmodel.selected_model_name');
                if (this.modelShowName.length > 30) {
                    this.modelShowName = this.modelShowName.substring(0, 30).concat("...");
                }
                this.modelShowName = selectedPrefix + this.modelShowName; 
            }

            this.mapping = convertRowsToMapping(thisModels);

            saveTags(node, thisModels);
            
            if (!firstLoad) {
                createDynamicMqttBroker(RED);
                firstLoad = true;
            }

        }
        
    });
})();
    

</script>
